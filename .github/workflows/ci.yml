name: C++ Qt6 CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # --- JOB 1: UBUNTU BUILD ---
  build-ubuntu:
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake build-essential libgl-dev \
          libglu1-mesa-dev \
          libgl1-mesa-dev \
          mesa-common-dev \
          qt6-base-dev \
          qt6-base-private-dev \
          libqt6widgets6 libqt6gui6 \
          libqt6test6 \
          qt6-test-dev-tools

    - name: Configure and Build
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: Run Tests
      run: |
        cd build
        export QT_QPA_PLATFORM=offscreen
        ctest --output-on-failure

  # --- JOB 2: REDHAT (ROCKY LINUX 9) BUILD ---
  build-redhat:
    runs-on: ubuntu-latest
    container: 
      image: rockylinux:9
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        # Enable CRB (Code Ready Builder) to find development headers
        dnf install -y epel-release 'dnf-command(config-manager)'
        dnf config-manager --set-enabled crb
        dnf makecache
        
        dnf update -y
        dnf install -y gcc-c++ cmake make mesa-libGL-devel \
          mesa-libGLU-devel \
          qt6-qtbase-devel \
          qt6-qtbase-gui \
          qt6-qtdeclarative-devel \
          qt6-qtbase-private-devel

    - name: Configure and Build
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: Run Tests
      run: |
        cd build
        export QT_QPA_PLATFORM=offscreen
        ctest --output-on-failure
